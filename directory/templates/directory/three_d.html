<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Campus View</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<style>
body {
    margin: 0;
    background: #f4f6f5;
    font-family: "Segoe UI", sans-serif;
}

.navbar {
    background: linear-gradient(90deg, #0f5132, #198754);
}

.navbar-brand {
    color: #fff !important;
    font-weight: 600;
}

#info {
    position: absolute;
    top: 90px;
    left: 20px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    max-width: 280px;
    z-index: 5;
}

#zoomControls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 5;
}

canvas {
    display: block;
}
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar px-4 py-3">
    <span class="navbar-brand">
        <i class="bi bi-box"></i> 3D Campus View
    </span>

    <div class="ms-auto d-flex gap-2">
        <button id="backBtn" class="btn btn-light btn-sm" style="display:none;">
            ‚¨Ö Back
        </button>
        <a href="{% url 'home' %}" class="btn btn-light btn-sm">
            üè† Home
        </a>
    </div>
</nav>

<!-- INFO PANEL -->
<div id="info">
    <strong id="infoTitle">Campus</strong>
    <p id="infoDesc" class="small text-muted mb-0">
        Click a building to begin
    </p>
</div>

<!-- ZOOM CONTROLS -->
<div id="zoomControls">
    <button id="zoomIn" class="btn btn-success btn-sm shadow">‚ûï Zoom In</button>
    <button id="zoomOut" class="btn btn-secondary btn-sm shadow">‚ûñ Zoom Out</button>
</div>

<!-- ROOM MODAL -->
<div class="modal fade" id="roomModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="roomTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="roomDesc"></p>
        <img id="roomImg" class="img-fluid rounded mt-3">

        <hr>
        <h6 class="text-success">Assigned Personnel</h6>
        <div id="personnelList" class="list-group mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- PERSONNEL MODAL -->
<div class="modal fade" id="personnelModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="personnelName"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="personnelPhoto" class="img-fluid rounded mb-3" style="max-height:200px;">
        <p><strong>Email:</strong> <span id="personnelEmail"></span></p>
        <p><strong>Contact:</strong> <span id="personnelContact"></span></p>
      </div>
    </div>
  </div>
</div>

<script>
const data = {{ buildings|safe }};

let level = "building";
let selectedBuilding = null;

// SCENE
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf4f6f5);

// CAMERA
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 18, 26);
camera.lookAt(0, 6, 0);

// RENDERER
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHTS
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(10,20,10);
scene.add(dirLight);

// GROUP
const group = new THREE.Group();
scene.add(group);

// COLORS
const buildingColors = [0x198754, 0x0d6efd, 0xfd7e14];
const floorColor = 0x6ea8fe;
const roomColor = 0xffe69c;

// UI
const infoTitle = document.getElementById("infoTitle");
const infoDesc  = document.getElementById("infoDesc");
const backBtn   = document.getElementById("backBtn");

// CLICKABLE OBJECTS
let clickable = [];

// CLEAR SCENE
function clearScene() {
    group.clear();
    clickable = [];
}

// LABEL TEXTURE (CRISP)
function createTextTexture(text) {
    const canvas = document.createElement("canvas");
    canvas.width = 1024;
    canvas.height = 256;

    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = "#198754";
    ctx.lineWidth = 10;
    ctx.strokeRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#000";
    ctx.font = "bold 96px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, canvas.width / 2, canvas.height / 2);

    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.NearestFilter;
    texture.magFilter = THREE.NearestFilter;
    return texture;
}

// CREATE BOX + LABEL
function createBox(w,h,d,color,x,y,z,label,userData) {
    const mesh = new THREE.Mesh(
        new THREE.BoxGeometry(w,h,d),
        new THREE.MeshStandardMaterial({ color })
    );
    mesh.position.set(x,y,z);
    mesh.userData = userData;
    group.add(mesh);
    clickable.push(mesh);

    const sprite = new THREE.Sprite(
        new THREE.SpriteMaterial({
            map: createTextTexture(label),
            depthTest:false
        })
    );
    sprite.scale.set(w * 1.8, h * 0.8, 1);
    sprite.position.set(x, y + h/2 + 1.6, z);

    // üîë PREVENT LABEL FROM BLOCKING CLICKS
    sprite.raycast = () => {};

    group.add(sprite);
}

// BUILDINGS
function showBuildings() {
    clearScene();
    level = "building";
    backBtn.style.display = "none";

    infoTitle.innerText = "Campus Buildings";
    infoDesc.innerText = "Click a building to view floors";

    const radius = 10;
    const step = (Math.PI * 2) / data.length;

    data.forEach((b,i)=>{
        const h = b.floors.length * 3;
        const a = i * step;
        createBox(
            4, h, 4,
            buildingColors[i % buildingColors.length],
            Math.cos(a)*radius,
            h/2,
            Math.sin(a)*radius,
            b.name,
            { type:"building", data:b }
        );
    });
}

// FLOORS
function showFloors(building) {
    clearScene();
    level = "floor";
    selectedBuilding = building;
    backBtn.style.display = "inline-block";

    infoTitle.innerText = building.name;
    infoDesc.innerText = "Click a floor to view rooms";

    let y = 1.5;
    building.floors.forEach(f=>{
        createBox(
            6, 2.5, 6,
            floorColor,
            0, y, 0,
            "Floor " + f.number,
            { type:"floor", data:f }
        );
        y += 3;
    });
}

// ROOMS
function showRooms(floor) {
    clearScene();
    level = "room";

    infoTitle.innerText = "Floor " + floor.number;
    infoDesc.innerText = "Click a room to view details";

    const cols = 4;
    const gap = 3;
    const startX = -((cols-1)*gap)/2;
    let x = startX, z = 0, i = 0;

    floor.rooms.forEach(r=>{
        createBox(
            2.2, 1.5, 2.2,
            roomColor,
            x, 1, z,
            r.number,
            { type:"room", data:r }
        );
        x += gap;
        i++;
        if (i % cols === 0) {
            x = startX;
            z += gap;
        }
    });
}

// CLICK HANDLER
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener("click", e=>{
    mouse.x = (e.clientX/window.innerWidth)*2-1;
    mouse.y = -(e.clientY/window.innerHeight)*2+1;
    raycaster.setFromCamera(mouse, camera);

    const hits = raycaster.intersectObjects(clickable, true);
    if (!hits.length) return;

    const clicked = hits[0].object;
    if (!clicked.userData || !clicked.userData.type) return;

    const obj = clicked.userData;

    if (obj.type === "building") showFloors(obj.data);
    else if (obj.type === "floor") showRooms(obj.data);
    else if (obj.type === "room") {

        document.getElementById("roomTitle").innerText =
            obj.data.number + " - " + obj.data.name;
        document.getElementById("roomDesc").innerText =
            obj.data.description;

        const img = document.getElementById("roomImg");
        if (obj.data.photo) {
            img.src = obj.data.photo;
            img.style.display = "block";
        } else img.style.display = "none";

        const list = document.getElementById("personnelList");
        list.innerHTML = "";

        const personnel = obj.data.personnel || [];

        if (personnel.length > 0) {
            personnel.forEach(p=>{
                const item = document.createElement("a");
                item.className = "list-group-item list-group-item-action";
                item.innerHTML = `<strong>${p.name}</strong>`;
                item.onclick = ()=>{
                    document.getElementById("personnelName").innerText = p.name;
                    document.getElementById("personnelEmail").innerText = p.email || "N/A";
                    document.getElementById("personnelContact").innerText = p.contact || "N/A";

                    const photo = document.getElementById("personnelPhoto");
                    if (p.photo) {
                        photo.src = p.photo;
                        photo.style.display = "block";
                    } else photo.style.display = "none";

                    new bootstrap.Modal(
                        document.getElementById("personnelModal")
                    ).show();
                };
                list.appendChild(item);
            });
        } else {
            list.innerHTML =
                "<div class='text-muted small'>No assigned personnel</div>";
        }

        new bootstrap.Modal(
            document.getElementById("roomModal")
        ).show();
    }
});

// BACK
backBtn.onclick = ()=>{
    if (level === "room") showFloors(selectedBuilding);
    else if (level === "floor") showBuildings();
};

// ZOOM
document.getElementById("zoomIn").onclick = ()=> {
    camera.position.z = Math.max(14, camera.position.z - 2);
};
document.getElementById("zoomOut").onclick = ()=> {
    camera.position.z = Math.min(40, camera.position.z + 2);
};

// ANIMATE
function animate() {
    requestAnimationFrame(animate);
    group.rotation.y += 0.002;
    group.children.forEach(o=>{
        if (o.type === "Sprite") o.quaternion.copy(camera.quaternion);
    });
    renderer.render(scene,camera);
}
animate();

// INIT
showBuildings();

// RESIZE
window.addEventListener("resize",()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
